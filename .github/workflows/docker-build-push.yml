name: Deploy Services to ECS

on:
  workflow_dispatch:
    inputs:
      api-gateway:
        description: 'API Gateway'
        type: boolean
        default: false
      auth-service:
        description: 'Auth Service'
        type: boolean
        default: false
      user-service:
        description: 'User Service'
        type: boolean
        default: false
      job-service:
        description: 'Job Service'
        type: boolean
        default: false
      application-service:
        description: 'Application Service'
        type: boolean
        default: false
      admin-service:
        description: 'Admin Service'
        type: boolean
        default: false
      notification-service:
        description: 'Notification Service'
        type: boolean
        default: false
      payment-service:
        description: 'Payment Service'
        type: boolean
        default: false
      messaging-service:
        description: 'Messaging Service'
        type: boolean
        default: false
      recommendation-service:
        description: 'Recommendation Service'
        type: boolean
        default: false
      deploy-all:
        description: 'Deploy ALL services'
        type: boolean
        default: false

env:
  AWS_REGION: ap-south-1
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-south-1.amazonaws.com
  ECS_CLUSTER: ai-job-portal-dev

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Build service matrix
        id: set-matrix
        run: |
          services=()
          if [[ "${{ inputs.deploy-all }}" == "true" ]]; then
            services=("api-gateway" "auth-service" "user-service" "job-service" "application-service" "admin-service" "notification-service" "payment-service" "messaging-service" "recommendation-service")
          else
            [[ "${{ inputs.api-gateway }}" == "true" ]] && services+=("api-gateway")
            [[ "${{ inputs.auth-service }}" == "true" ]] && services+=("auth-service")
            [[ "${{ inputs.user-service }}" == "true" ]] && services+=("user-service")
            [[ "${{ inputs.job-service }}" == "true" ]] && services+=("job-service")
            [[ "${{ inputs.application-service }}" == "true" ]] && services+=("application-service")
            [[ "${{ inputs.admin-service }}" == "true" ]] && services+=("admin-service")
            [[ "${{ inputs.notification-service }}" == "true" ]] && services+=("notification-service")
            [[ "${{ inputs.payment-service }}" == "true" ]] && services+=("payment-service")
            [[ "${{ inputs.messaging-service }}" == "true" ]] && services+=("messaging-service")
            [[ "${{ inputs.recommendation-service }}" == "true" ]] && services+=("recommendation-service")
          fi

          if [ ${#services[@]} -eq 0 ]; then
            echo "::error::No services selected. Please select at least one service."
            exit 1
          fi

          json=$(printf '%s\n' "${services[@]}" | jq -R . | jq -sc .)
          echo "matrix={\"service\":$json}" >> $GITHUB_OUTPUT
          echo "Deploying: ${services[*]}"

  build-deploy:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.ECR_REGISTRY }}/ai-job-portal/${{ matrix.service }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          build-args: SERVICE=${{ matrix.service }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to ECS
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ matrix.service }} \
            --force-new-deployment \
            --no-cli-pager
          echo "âœ… ${{ matrix.service }} deployed"

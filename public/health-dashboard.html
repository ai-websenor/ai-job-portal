<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Service Status | AI Job Portal</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                background: #f8f9fa;
                min-height: 100vh;
                color: #212529;
                font-size: 14px;
                line-height: 1.5;
            }

            .container {
                max-width: 960px;
                margin: 0 auto;
                padding: 0 16px;
            }

            header {
                background: #fff;
                border-bottom: 1px solid #dee2e6;
                padding: 16px 0;
                margin-bottom: 24px;
            }

            .header-content {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            h1 {
                font-size: 18px;
                font-weight: 600;
                color: #212529;
            }

            .summary-stats {
                display: flex;
                gap: 24px;
                font-size: 13px;
                color: #6c757d;
            }

            .stat-item {
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .stat-count {
                font-weight: 600;
                color: #212529;
            }

            .status-banner {
                background: #fff;
                border: 1px solid #dee2e6;
                border-radius: 4px;
                padding: 16px 20px;
                margin-bottom: 24px;
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .status-banner.all-operational {
                border-left: 4px solid #28a745;
            }

            .status-banner.degraded {
                border-left: 4px solid #dc3545;
            }

            .status-indicator {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                flex-shrink: 0;
            }

            .status-indicator.operational {
                background: #28a745;
            }

            .status-indicator.down {
                background: #dc3545;
            }

            .status-indicator.checking {
                background: #6c757d;
            }

            .status-banner-text {
                font-weight: 500;
            }

            .status-banner-meta {
                margin-left: auto;
                font-size: 13px;
                color: #6c757d;
            }

            .section-title {
                font-size: 13px;
                font-weight: 600;
                color: #6c757d;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-bottom: 12px;
            }

            .services-list {
                background: #fff;
                border: 1px solid #dee2e6;
                border-radius: 4px;
                overflow: hidden;
            }

            .service-row {
                display: flex;
                align-items: center;
                padding: 12px 16px;
                border-bottom: 1px solid #e9ecef;
            }

            .service-row:last-child {
                border-bottom: none;
            }

            .service-row:hover {
                background: #f8f9fa;
            }

            .service-status {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                margin-right: 12px;
                flex-shrink: 0;
            }

            .service-status.operational {
                background: #28a745;
            }

            .service-status.down {
                background: #dc3545;
            }

            .service-status.checking {
                background: #6c757d;
                animation: pulse 1.5s ease-in-out infinite;
            }

            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.4; }
            }

            .service-info {
                flex: 1;
                min-width: 0;
            }

            .service-name {
                font-weight: 500;
                color: #212529;
            }

            .service-desc {
                font-size: 13px;
                color: #6c757d;
                margin-top: 2px;
            }

            .service-meta {
                display: flex;
                align-items: center;
                gap: 16px;
                margin-left: 16px;
            }

            .service-port {
                font-size: 13px;
                color: #6c757d;
                font-family: "SF Mono", Monaco, Consolas, monospace;
                background: #f1f3f4;
                padding: 2px 8px;
                border-radius: 3px;
            }

            .service-latency {
                font-size: 13px;
                color: #6c757d;
                min-width: 60px;
                text-align: right;
            }

            .service-status-text {
                font-size: 13px;
                min-width: 80px;
                text-align: right;
            }

            .service-status-text.operational {
                color: #28a745;
            }

            .service-status-text.down {
                color: #dc3545;
            }

            .service-status-text.checking {
                color: #6c757d;
            }

            .footer {
                margin-top: 32px;
                padding: 16px 0;
                border-top: 1px solid #dee2e6;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .footer-text {
                font-size: 13px;
                color: #6c757d;
            }

            .refresh-btn {
                font-size: 13px;
                padding: 6px 12px;
                border-radius: 3px;
                border: 1px solid #dee2e6;
                background: #fff;
                color: #212529;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .refresh-btn:hover {
                background: #f1f3f4;
            }

            .refresh-btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }

            .refresh-icon {
                display: inline-block;
                transition: transform 0.3s;
            }

            .refresh-btn.loading .refresh-icon {
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }

            .error-text {
                font-size: 12px;
                color: #dc3545;
                margin-top: 4px;
            }

            .env-badge {
                font-size: 11px;
                padding: 2px 6px;
                border-radius: 3px;
                background: #e9ecef;
                color: #6c757d;
                margin-left: 8px;
            }
        </style>
    </head>
    <body>
        <header>
            <div class="container">
                <div class="header-content">
                    <h1>AI Job Portal — Service Status <span class="env-badge" id="envBadge">-</span></h1>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <span class="stat-count" id="healthyCount">-</span>
                            <span>Operational</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-count" id="unhealthyCount">-</span>
                            <span>Down</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-count" id="totalCount">-</span>
                            <span>Total</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="container">
            <div class="status-banner all-operational" id="statusBanner">
                <div class="status-indicator operational" id="bannerIndicator"></div>
                <span class="status-banner-text" id="bannerText">Checking services...</span>
                <span class="status-banner-meta">Updated <span id="lastUpdated">-</span></span>
            </div>

            <div class="section-title">Services</div>
            <div class="services-list" id="servicesList">
                <!-- Services will be rendered here -->
            </div>

            <div class="footer">
                <span class="footer-text">Auto-refresh every 30 seconds</span>
                <button class="refresh-btn" id="refreshBtn" onclick="refreshHealth()">
                    <span class="refresh-icon">↻</span>
                    Refresh
                </button>
            </div>
        </main>

        <script>
            const serviceDescriptions = {
                "api-gateway": "Main entry point & request routing",
                "auth-service": "Authentication, sessions & social logins",
                "user-service": "Profiles, companies, teams & documents",
                "job-service": "Jobs, screening questions & analytics",
                "application-service": "Job applications & interviews",
                "notification-service": "Email, SMS & push notifications",
                "payment-service": "Payments & subscriptions",
                "admin-service": "Admin panel, support & content management",
                "messaging-service": "Direct messages & chatbot sessions",
                "recommendation-service": "AI job recommendations & interaction tracking",
            };

            const servicePorts = {
                "api-gateway": 3000,
                "auth-service": 3001,
                "user-service": 3002,
                "job-service": 3003,
                "application-service": 3004,
                "notification-service": 3005,
                "payment-service": 3006,
                "admin-service": 3007,
                "messaging-service": 3008,
                "recommendation-service": 3009,
            };

            let healthData = {};
            let isLocal = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";

            // Detect environment
            document.getElementById("envBadge").textContent = isLocal ? "Local" : "AWS";

            function formatServiceName(name) {
                return name.split("-").map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(" ");
            }

            function renderServices() {
                const list = document.getElementById("servicesList");
                const services = Object.keys(serviceDescriptions);

                list.innerHTML = services
                    .map((serviceName) => {
                        const health = healthData[serviceName] || { status: "checking" };
                        const port = servicePorts[serviceName];
                        const statusText = health.status === "healthy" || health.status === "operational"
                            ? "Operational"
                            : health.status === "down" || health.status === "unhealthy"
                                ? "Down"
                                : "Checking";
                        const statusClass = statusText === "Operational" ? "operational" : statusText === "Down" ? "down" : "checking";

                        return `
                            <div class="service-row">
                                <div class="service-status ${statusClass}"></div>
                                <div class="service-info">
                                    <div class="service-name">${formatServiceName(serviceName)}</div>
                                    <div class="service-desc">${serviceDescriptions[serviceName]}</div>
                                </div>
                                <div class="service-meta">
                                    <span class="service-port">:${port}</span>
                                    <span class="service-latency">${health.responseTime ? health.responseTime + "ms" : "-"}</span>
                                    <span class="service-status-text ${statusClass}">${statusText}</span>
                                </div>
                            </div>
                        `;
                    })
                    .join("");

                // Update summary counts
                const operational = Object.values(healthData).filter(h => h.status === "healthy" || h.status === "operational").length;
                const down = Object.values(healthData).filter(h => h.status === "down" || h.status === "unhealthy").length;

                document.getElementById("healthyCount").textContent = operational;
                document.getElementById("unhealthyCount").textContent = down;
                document.getElementById("totalCount").textContent = Object.keys(serviceDescriptions).length;
                document.getElementById("lastUpdated").textContent = new Date().toLocaleTimeString();

                // Update banner
                const banner = document.getElementById("statusBanner");
                const bannerIndicator = document.getElementById("bannerIndicator");
                const bannerText = document.getElementById("bannerText");

                if (down > 0) {
                    banner.className = "status-banner degraded";
                    bannerIndicator.className = "status-indicator down";
                    bannerText.textContent = `${down} service${down > 1 ? "s" : ""} experiencing issues`;
                } else if (operational === Object.keys(serviceDescriptions).length) {
                    banner.className = "status-banner all-operational";
                    bannerIndicator.className = "status-indicator operational";
                    bannerText.textContent = "All systems operational";
                } else {
                    banner.className = "status-banner";
                    bannerIndicator.className = "status-indicator checking";
                    bannerText.textContent = "Checking services...";
                }
            }

            async function refreshHealth() {
                const btn = document.getElementById("refreshBtn");
                btn.classList.add("loading");
                btn.disabled = true;

                // Reset to checking state
                Object.keys(serviceDescriptions).forEach(name => {
                    healthData[name] = { status: "checking" };
                });
                renderServices();

                try {
                    // Use the aggregated health endpoint from API Gateway
                    const response = await fetch("/api/v1/health/services");
                    const data = await response.json();

                    // API Gateway health
                    healthData["api-gateway"] = {
                        status: data.gateway === "healthy" ? "healthy" : "down"
                    };

                    // Other services from the response
                    if (data.services && Array.isArray(data.services)) {
                        data.services.forEach(svc => {
                            const name = svc.name;
                            healthData[name] = {
                                status: svc.status === "healthy" ? "healthy" : "down",
                                responseTime: svc.responseTime
                            };
                        });
                    }

                    // Mark services not in response as down
                    Object.keys(serviceDescriptions).forEach(name => {
                        if (!healthData[name] || healthData[name].status === "checking") {
                            healthData[name] = { status: "down" };
                        }
                    });

                } catch (error) {
                    console.error("Failed to fetch health:", error);
                    // If we can't reach the API, mark all as down except we know API gateway responded
                    Object.keys(serviceDescriptions).forEach(name => {
                        healthData[name] = { status: "down" };
                    });
                }

                renderServices();
                btn.classList.remove("loading");
                btn.disabled = false;
            }

            // Initial load
            renderServices();
            refreshHealth();

            // Auto-refresh every 30 seconds
            setInterval(refreshHealth, 30000);
        </script>
    </body>
</html>
